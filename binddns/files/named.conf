{%- from "binddns/defaults.yaml" import rawmap with context -%}
{%- set datamap = salt['grains.filter_by'](rawmap, merge=salt['pillar.get']('binddns:lookup')) -%}

{%- if datamap['config']['named.conf']['file_prepend'] is defined -%}
{{ datamap['config']['named.conf']['file_prepend'] }}

{% endif -%}

{% if 'rndc.key' in datamap['config']['manage'] -%}
include "{{ datamap['config']['rndc.key']['path'] }}";

{% endif -%}

{%- set controls = [] -%}
{%- if datamap['config']['named.conf']['default_controls'] is defined -%}
  {%- set controls = datamap['config']['named.conf']['default_controls'] -%}
{%- endif -%}
{%- if datamap['config']['named.conf']['controls'] is defined -%}
  {%- do controls.extend(datamap['config']['named.conf']['controls']) -%}
{%- endif -%}

controls {
  {%- for c in controls %}
  {{ c }}
  {%- endfor %}
};

{% set options = ['include "/etc/bind/named.conf.options";'] -%}
{%- if datamap['config']['named.conf']['default_options'] is defined -%}
  {%- set options = datamap['config']['named.conf']['default_options'] -%}
{%- endif -%}
{%- if datamap['config']['named.conf']['options'] is defined -%}
  {%- do options.extend(datamap['config']['named.conf']['options']) -%}
{%- endif -%}

options {
  {%- for o in options %}
  {{ o }}
  {%- endfor %}
};

{% set includes = [datamap.config.localzones.path] -%}

{% if 'zoneconfigs' in datamap.config.manage -%}
{% do includes.extend([datamap.config.zoneconfigs.path]) -%}
{%- endif -%}

{%- if datamap['config']['named.conf']['default_includes'] is defined -%}
  {%- set includes = datamap['config']['named.conf']['default_includes'] -%}
{%- endif -%}
{%- if datamap['config']['named.conf']['includes'] is defined -%}
  {%- do includes.extend(datamap['config']['named.conf']['includes']) -%}
{%- endif -%}

{%- for i in includes %}
include "{{ i }}";
{%- endfor -%}

{%- if datamap['config']['named.conf']['file_append'] is defined %}

{{ datamap['config']['named.conf']['file_append'] }}
{%- endif -%}
